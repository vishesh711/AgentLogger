# Database Migrations

This guide explains how to work with database migrations in the AgentLogger project using Alembic.

## Overview

AgentLogger uses [Alembic](https://alembic.sqlalchemy.org/) for database migrations. Alembic is a database migration tool for SQLAlchemy that allows you to:

- Track changes to your database schema
- Apply and revert migrations
- Generate migration scripts automatically based on model changes

## Migration Files

Migration files are stored in the `alembic/versions/` directory. Each migration file has a unique revision ID and contains Python code to upgrade and downgrade the database schema.

## Creating Migrations

### Automatic Migration Generation

The easiest way to create a migration is to let Alembic generate it automatically based on the differences between your SQLAlchemy models and the current database schema:

```bash
alembic revision --autogenerate -m "description of changes"
```

This will:
1. Compare your SQLAlchemy models to the current database schema
2. Generate a migration script in `alembic/versions/`
3. Include Python code to apply and revert the changes

### Manual Migration Creation

You can also create a migration manually:

```bash
alembic revision -m "description of changes"
```

This will create an empty migration script that you can fill in manually.

## Applying Migrations

### Upgrading to the Latest Version

To apply all pending migrations:

```bash
alembic upgrade head
```

### Upgrading to a Specific Version

To apply migrations up to a specific version:

```bash
alembic upgrade revision_id
```

### Upgrading by a Relative Number

To apply a specific number of migrations:

```bash
alembic upgrade +1  # Apply the next migration
alembic upgrade +2  # Apply the next two migrations
```

## Reverting Migrations

### Downgrading to a Previous Version

To revert to a previous version:

```bash
alembic downgrade revision_id
```

### Downgrading by a Relative Number

To revert a specific number of migrations:

```bash
alembic downgrade -1  # Revert the last migration
alembic downgrade -2  # Revert the last two migrations
```

### Downgrading to Base

To revert all migrations:

```bash
alembic downgrade base
```

## Checking Migration Status

### Current Revision

To see the current revision of the database:

```bash
alembic current
```

### Migration History

To see the migration history:

```bash
alembic history
```

## Best Practices

### 1. Always Review Autogenerated Migrations

Alembic's autogenerate feature is powerful but not perfect. Always review autogenerated migrations before applying them to:

- Ensure they capture all intended changes
- Remove unintended changes
- Add any custom SQL or data migrations that can't be autogenerated

### 2. Include Data Migrations When Necessary

Sometimes you need to migrate data as well as schema. Include data migrations in your migration scripts:

```python
def upgrade():
    # Schema changes
    op.add_column('users', sa.Column('full_name', sa.String(), nullable=True))
    
    # Data migration
    connection = op.get_bind()
    connection.execute(
        text("UPDATE users SET full_name = first_name || ' ' || last_name")
    )

def downgrade():
    # Schema changes
    op.drop_column('users', 'full_name')
```

### 3. Test Migrations

Always test migrations, especially on a copy of production data, before applying them to production:

```bash
# In development/staging environment
alembic upgrade head
alembic downgrade -1  # Test downgrade
alembic upgrade +1    # Test upgrade again
```

### 4. Use Meaningful Migration Messages

Use clear, descriptive messages for your migrations:

```bash
# Good
alembic revision --autogenerate -m "add user full_name column"

# Bad
alembic revision --autogenerate -m "update users"
```

### 5. Avoid Modifying Existing Migrations

Once a migration has been applied to any environment, avoid modifying it. Instead, create a new migration to fix any issues.

## Common Issues

### "Target database is not up to date"

This error occurs when you try to autogenerate a migration but your database is not at the latest revision. To fix it:

```bash
alembic upgrade head
alembic revision --autogenerate -m "your message"
```

### "Can't locate revision identified by 'xyz'"

This error occurs when you try to upgrade or downgrade to a revision that doesn't exist. Check your revision ID:

```bash
alembic history
```

### "Multiple head revisions are present"

This error occurs when you have multiple migration branches. You need to merge them:

```bash
alembic merge -m "merge branches" revision1 revision2
```

## Example: Adding a New Column

Here's an example workflow for adding a new column to an existing table:

1. Update the SQLAlchemy model:

```python
# app/models/db/user.py
class User(Base):
    __tablename__ = "users"
    
    id = Column(UUID(as_uuid=True), primary_key=True, default=uuid.uuid4)
    email = Column(String, unique=True, index=True, nullable=False)
    full_name = Column(String)  # New column
```

2. Generate a migration:

```bash
alembic revision --autogenerate -m "add user full_name column"
```

3. Review the generated migration in `alembic/versions/`.

4. Apply the migration:

```bash
alembic upgrade head
```

5. Verify the change in the database:

```bash
psql -U postgres -d agentlogger_dev -c "\d users"
``` 